# System Architecture & Data Flow

## ğŸ—ï¸ Component Interaction Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CLIENT LAYER                            â”‚
â”‚  (Web Browser, Mobile App, Python Script, etc.)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ HTTP Requests / WebSocket
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FASTAPI APPLICATION                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Routes Layer                                             â”‚  â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚ â”‚ /graphs        - Create, list, get, delete graphs   â”‚ â”‚  â”‚
â”‚  â”‚ â”‚ /executions    - Run, get state, get results        â”‚ â”‚  â”‚
â”‚  â”‚ â”‚ /ws/execute    - WebSocket real-time streaming      â”‚ â”‚  â”‚
â”‚  â”‚ â”‚ /health, /     - Server health & info               â”‚ â”‚  â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚ Request Validation (Pydantic)                          â”‚  â”‚
â”‚  â”‚ â””â”€ GraphDefinition, ExecutionRunRequest, etc.          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                            â”‚                                    â”‚
â”‚                            â–¼                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Application Logic Layer                                  â”‚  â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚ â”‚ WorkflowEngine                                       â”‚ â”‚  â”‚
â”‚  â”‚ â”‚  - DAG traversal                                     â”‚ â”‚  â”‚
â”‚  â”‚ â”‚  - Node execution orchestration                      â”‚ â”‚  â”‚
â”‚  â”‚ â”‚  - Condition evaluation                              â”‚ â”‚  â”‚
â”‚  â”‚ â”‚  - Loop detection & handling                         â”‚ â”‚  â”‚
â”‚  â”‚ â”‚  - Event emission (for WebSocket)                    â”‚ â”‚  â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚ â”‚ ToolRegistry                                         â”‚ â”‚  â”‚
â”‚  â”‚ â”‚  - Dynamic tool lookup                               â”‚ â”‚  â”‚
â”‚  â”‚ â”‚  - Tool registration                                 â”‚ â”‚  â”‚
â”‚  â”‚ â”‚ Used by: extract_functions, check_complexity, etc.   â”‚ â”‚  â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚ â”‚ WorkflowState                                        â”‚ â”‚  â”‚
â”‚  â”‚ â”‚  - Shared state across workflow execution           â”‚ â”‚  â”‚
â”‚  â”‚ â”‚  - Updated by each node                              â”‚ â”‚  â”‚
â”‚  â”‚ â”‚  - Passed to next node                               â”‚ â”‚  â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                            â”‚                                    â”‚
â”‚                            â–¼                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Data Access Layer                                        â”‚  â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚ â”‚ Database                                             â”‚ â”‚  â”‚
â”‚  â”‚ â”‚  - AsyncSession management                           â”‚ â”‚  â”‚
â”‚  â”‚ â”‚  - SQLAlchemy async engine                           â”‚ â”‚  â”‚
â”‚  â”‚ â”‚ GraphRepository                                       â”‚ â”‚  â”‚
â”‚  â”‚ â”‚  - CRUD operations for graphs                         â”‚ â”‚  â”‚
â”‚  â”‚ â”‚ ExecutionRepository                                   â”‚ â”‚  â”‚
â”‚  â”‚ â”‚  - CRUD operations for executions                     â”‚ â”‚  â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DATABASE LAYER                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ SQLite (In-Memory for Development)                       â”‚ â”‚
â”‚  â”‚                                                          â”‚ â”‚
â”‚  â”‚ Tables:                                                  â”‚ â”‚
â”‚  â”‚ â”Œâ”€ graph_model â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚ â”‚ id: UUID                                           â”‚ â”‚ â”‚
â”‚  â”‚ â”‚ name: str                                          â”‚ â”‚ â”‚
â”‚  â”‚ â”‚ definition: JSON (nodes, edges, entry_node)        â”‚ â”‚ â”‚
â”‚  â”‚ â”‚ created_at: timestamp                              â”‚ â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚                                                          â”‚ â”‚
â”‚  â”‚ â”Œâ”€ execution_model â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚ â”‚ run_id: UUID                                       â”‚ â”‚ â”‚
â”‚  â”‚ â”‚ graph_id: UUID (FK)                                â”‚ â”‚ â”‚
â”‚  â”‚ â”‚ status: enum (running, completed, failed)          â”‚ â”‚ â”‚
â”‚  â”‚ â”‚ result: JSON (state, logs)                         â”‚ â”‚ â”‚
â”‚  â”‚ â”‚ started_at: timestamp                              â”‚ â”‚ â”‚
â”‚  â”‚ â”‚ completed_at: timestamp                            â”‚ â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Execution Flow (Step-by-Step)

### Request â†’ Response Cycle

```
CLIENT REQUEST
    â”‚
    â”‚ POST /executions/run
    â”‚ {"graph_id": "abc123", "initial_state": {...}}
    â”‚
    â–¼
FASTAPI ENDPOINT (app/api/routes/execution.py)
    â”‚
    â”œâ”€ Validate request (Pydantic)
    â”‚
    â”œâ”€ Fetch graph from database
    â”‚  â””â”€ SELECT * FROM graph_model WHERE id = "abc123"
    â”‚
    â”œâ”€ Spawn background async task
    â”‚  â””â”€ execute_workflow_background()
    â”‚
    â””â”€â–º RETURN IMMEDIATELY (run_id: "xyz789")
        â”‚
        â””â”€ Client now has run_id
           Can poll results while task runs

BACKGROUND TASK (execute_workflow_background)
    â”‚
    â”œâ”€ Initialize WorkflowState with initial_state
    â”‚
    â”œâ”€ Create WorkflowEngine
    â”‚
    â”œâ”€ Call engine.execute(graph, state)
    â”‚  â”‚
    â”‚  â””â”€ ENGINE EXECUTION LOOP:
    â”‚     â”‚
    â”‚     â”œâ”€ [1] Get entry_node from graph
    â”‚     â”‚
    â”‚     â”œâ”€ [LOOP] While current_node exists:
    â”‚     â”‚   â”‚
    â”‚     â”‚   â”œâ”€ Get node definition
    â”‚     â”‚   â”‚
    â”‚     â”‚   â”œâ”€ Fetch tool from registry
    â”‚     â”‚   â”‚  â””â”€ tool_registry.get(node.tool)
    â”‚     â”‚   â”‚
    â”‚     â”‚   â”œâ”€ Execute tool (async)
    â”‚     â”‚   â”‚  â””â”€ output = await tool(state)
    â”‚     â”‚   â”‚
    â”‚     â”‚   â”œâ”€ Update WorkflowState
    â”‚     â”‚   â”‚  â””â”€ state.update(output)
    â”‚     â”‚   â”‚
    â”‚     â”‚   â”œâ”€ Log execution
    â”‚     â”‚   â”‚  â””â”€ Create ExecutionLog entry
    â”‚     â”‚   â”‚
    â”‚     â”‚   â”œâ”€ Evaluate edges (find next node)
    â”‚     â”‚   â”‚  â””â”€ For each outgoing edge:
    â”‚     â”‚   â”‚     - If conditional: evaluate condition
    â”‚     â”‚   â”‚     - If true: set as next_node
    â”‚     â”‚   â”‚     - Otherwise: try next edge
    â”‚     â”‚   â”‚
    â”‚     â”‚   â”œâ”€ Check for loops
    â”‚     â”‚   â”‚  â””â”€ If same edge traversed >100 times: STOP
    â”‚     â”‚   â”‚
    â”‚     â”‚   â””â”€ Set current_node = next_node
    â”‚     â”‚
    â”‚     â””â”€ Return final state + logs
    â”‚
    â”œâ”€ Store execution result in database
    â”‚  â””â”€ UPDATE execution_model 
    â”‚      SET status = "completed", 
    â”‚          result = {...}
    â”‚
    â””â”€ Task complete

CLIENT POLLING
    â”‚
    â”œâ”€ GET /executions/result/xyz789
    â”‚  â””â”€ WHILE status != "completed":
    â”‚     â””â”€ Wait, then check again
    â”‚
    â””â”€ RECEIVE FINAL RESULT
        {
          "run_id": "xyz789",
          "status": "completed",
          "result": {
            "state": {...final state...},
            "logs": [...execution logs...]
          }
        }
```

---

## ğŸŒ WebSocket Real-Time Flow

```
CLIENT                              SERVER
   â”‚                                  â”‚
   â”‚â”€â”€â”€â”€ WS Connect â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚     /ws/execute/abc123           â”‚
   â”‚                                  â”‚
   â”‚â—„â”€â”€â”€â”€ Accept Connection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚                                  â”‚
   â”‚                    [START EXECUTION]
   â”‚                                  â”‚
   â”‚â—„â”€â”€ {node: "extract"} â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚    {event: "node_start"}         â”‚
   â”‚                                  â”‚
   â”‚    [Tool Executing...]           â”‚
   â”‚                                  â”‚
   â”‚â—„â”€â”€ {node: "extract"} â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚    {event: "node_complete"}      â”‚
   â”‚    {output: {...}}               â”‚
   â”‚                                  â”‚
   â”‚â—„â”€â”€ {node: "analyze"} â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚    {event: "node_start"}         â”‚
   â”‚                                  â”‚
   â”‚    [Tool Executing...]           â”‚
   â”‚                                  â”‚
   â”‚â—„â”€â”€ {node: "analyze"} â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚    {event: "node_complete"}      â”‚
   â”‚    {output: {...}}               â”‚
   â”‚                                  â”‚
   â”‚â—„â”€â”€ {event: "execution_complete"}â”€â”‚
   â”‚    {result: {...}}               â”‚
   â”‚    {duration_ms: 342}            â”‚
   â”‚                                  â”‚
   â”‚â”€â”€â”€â”€ Close Connection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                                  â”‚
```

**Advantages:**
- Real-time updates (no polling)
- Persistent connection
- Lower latency
- Better UX (live progress)

---

## ğŸ“Š State Management Flow

```
Initial State
â””â”€ {"code": "...", "user": "john"}

     â”‚ (NODE 1: extract_functions)
     â–¼

Updated State
â””â”€ {
     "code": "...",
     "user": "john",
     "functions": [...]  â† Added by Node 1
   }

     â”‚ (NODE 2: check_complexity)
     â–¼

Updated State
â””â”€ {
     "code": "...",
     "user": "john",
     "functions": [...],
     "complexity": {...}  â† Added by Node 2
   }

     â”‚ (NODE 3: detect_issues)
     â–¼

Final State
â””â”€ {
     "code": "...",
     "user": "john",
     "functions": [...],
     "complexity": {...},
     "issues": [...]  â† Added by Node 3
   }
```

**Key insight:** Each node reads from shared state, performs work, and updates state.

---

## ğŸ›¡ï¸ Error Handling Flow

```
Tool Execution
     â”‚
     â”œâ”€â–º Success
     â”‚    â””â”€ Update state, move to next node
     â”‚
     â””â”€â–º Exception
          â”‚
          â”œâ”€ Catch exception
          â”‚
          â”œâ”€ Log error details
          â”‚
          â”œâ”€ Update ExecutionModel
          â”‚  â””â”€ status = "failed"
          â”‚  â””â”€ error_message = str(exception)
          â”‚
          â””â”€ Stop execution
             â””â”€ Return execution result
                â””â”€ Client receives error
```

**Error information stored:**
```json
{
  "status": "failed",
  "error": "Tool 'complex_analysis' failed",
  "error_details": "division by zero at line 42",
  "failed_node": "analyze",
  "logs": [
    {...successful node logs...},
    {
      "node_id": "analyze",
      "status": "failed",
      "error": "division by zero at line 42"
    }
  ]
}
```

---

## ğŸ”Œ Tool Integration Points

```
WorkflowEngine
     â”‚
     â”œâ”€ Call: tool_registry.get(tool_name)
     â”‚         â””â”€ Returns: async function
     â”‚
     â””â”€ Call: await tool(state_dict)
              â””â”€ Returns: dict (updates)

Tool Definition:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ async def my_tool(state: dict) -> dict:  â”‚
â”‚     # Read from state                    â”‚
â”‚     data = state.get("key")              â”‚
â”‚                                          â”‚
â”‚     # Do work                            â”‚
â”‚     result = process(data)               â”‚
â”‚                                          â”‚
â”‚     # Return updates (merged with state) â”‚
â”‚     return {"new_key": result}           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ˆ Scaling Architecture (Future)

```
Current (Single Instance):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FastAPI Server  â”‚
â”‚   + SQLite DB    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Production (Scalable):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Load Balancer                 â”‚
â”‚    (nginx, AWS ALB, etc.)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”˜
                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚           â”‚           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”
â”‚FastAPI 1â”‚  â”‚FastAPI 2â”‚  â”‚FastAPI 3â”‚
â”‚Instance â”‚  â”‚Instance â”‚  â”‚Instance â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”˜
        â”‚           â”‚           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  PostgreSQL Database  â”‚
        â”‚  (Primary + Replica)  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Benefits:
âœ… Horizontal scaling (add more API servers)
âœ… Load distribution
âœ… Database replication
âœ… High availability
```

---

## ğŸ” Security Considerations

```
Client Request
     â”‚
     â”œâ”€ HTTPS/TLS encryption
     â”‚
     â”œâ”€ Input validation (Pydantic)
     â”‚  â””â”€ Reject invalid graph definitions
     â”‚
     â”œâ”€ Tool execution sandboxing
     â”‚  â””â”€ Tools run in isolated async context
     â”‚
     â”œâ”€ Database parameterization
     â”‚  â””â”€ Prevent SQL injection (SQLAlchemy)
     â”‚
     â””â”€ Rate limiting (can add)
        â””â”€ Prevent abuse
```

---

## âš¡ Performance Characteristics

```
Typical Execution Timeline:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Request received        â”‚ 0ms       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Validation              â”‚ 1ms       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ DB lookup               â”‚ 5ms       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Spawn background task   â”‚ 1ms       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Return run_id           â”‚ 7ms       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Background Task:        â”‚           â”‚
â”‚  Node 1 execution       â”‚ 50ms      â”‚
â”‚  Node 2 execution       â”‚ 100ms     â”‚
â”‚  Node 3 execution       â”‚ 75ms      â”‚
â”‚  DB store result        â”‚ 10ms      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ TOTAL                   â”‚ 242ms     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Memory Usage (approx):
- FastAPI server: 50MB
- Per concurrent execution: 1-5MB
- SQLite DB: 10-100MB
- Total for 100 concurrent: ~200MB
```

---

*Diagram created: December 10, 2025*
